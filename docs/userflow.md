# /docs/userflow.md

## 회의실 예약 서비스 유저플로우 설계 (Supabase 기반)

---

### 유저플로우 1 — 회의실 목록 조회 및 선택

**입력**  
- 사용자가 날짜(필수), 시작·종료 시간(또는 시간 블록), 인원 수, 위치(선택), 정렬/필터 옵션을 입력하고 회의실 목록 조회를 요청한다.

**처리**  
- 날짜·시간 유효성 검사(시작<끝, 과거 시각 제외, 영업 시간 범위 등).
- 시간대 표준화(서버 타임존 기준, 라운딩 규칙 적용).
- Supabase(Postgres)에서 rooms(이름/위치/정원/활성 여부)와 reservations(room_id, 시작/끝, 상태)을 조인하여 요청 구간과 겹치지 않는 회의실만 반환.
- 인원·위치 필터 적용, 정렬 및 페이지네이션 수행.
- 성능을 위해 가용성 뷰 또는 서버 함수(RPC) 활용. 캐싱 시 기준 시각 토큰 포함.

**출력**  
- 사용자가 선택 가능한 회의실 목록(이름, 위치, 정원, 가용 여부, 시간 블록 요약) 반환.
- 쿼리 기준 시각 토큰과 함께 제공.
- 엣지케이스: 조건에 맞는 회의실 없음, 정원 초과, 과거 시각 요청, 비활성 회의실, 시스템 점검 시 오류 코드 반환.

---

### 유저플로우 2 — 선택한 회의실의 세부 시간대 선택

**입력**  
- 사용자가 회의실 선택 후, 회의 길이, 시작 가능 시간 범위, 시간 단위(예: 30분), 완충시간 옵션을 입력한다.

**처리**  
- 입력값 정규화(타임존·라운딩 적용).
- 영업시간 기준으로 가능한 슬롯 생성 후 예약 충돌 여부 확인.
- reservations에서 확정/진행/홀드 상태와 겹침 판단. 완충시간 포함.
- 슬롯 클릭 시 holds 테이블에 잠정 예약(hold) 생성. TTL 기반 만료 관리.
- 중복 홀드 제한, expired hold 정리.
- 성능 최적화: room_id/date 범위 인덱스, RPC 함수 활용.

**출력**  
- 가능한 슬롯 리스트 반환(시작·종료 시간, 점유 구간, 선택 토큰).
- 슬롯 선택 시 hold 성공 여부와 남은 시간 안내.
- 엣지케이스: 동시 클릭 충돌, 완충시간으로 인한 불가, 영업시간 초과, 홀드 남용 제한 처리.

---

### 유저플로우 3 — 예약 정보 입력 및 검증, 최종 확정

**입력**  
- 사용자가 선택한 시간대(홀드 상태)와 함께 예약자 이름, 휴대폰 번호, 비밀번호(확인 입력 포함)를 입력한다.

**처리**  
- 기본 입력 검증: 비밀번호 정책, 전화번호 포맷 확인.
- 보안 처리: 휴대폰 번호·비밀번호 모두 해시/솔트 후 저장.
- 홀드 유효성 확인, 중복 예약 정책 검사.
- reservations 테이블에 확정 예약 insert. status="confirmed".
- 트랜잭션으로 겹치는 예약 재검증 후 충돌 시 롤백.
- 로그 기록.

**출력**  
- 예약 확정 성공: 예약 ID, 회의실 이름, 위치, 시간 등 반환.
- 실패 시 원인 코드(홀드 만료, 중복, 유효성 오류 등) 반환.
- 엣지케이스: 네트워크 지연·중복 클릭 → 트랜잭션 방지, 비밀번호 분실 시 재설정 불가 안내.

---

### 유저플로우 4 — 예약 조회 및 취소

**입력**  
- 사용자가 예약 조회/취소 메뉴에서 휴대폰 번호와 비밀번호 입력.
- 선택적으로 예약 ID, 취소 사유 입력.

**처리**  
- 인증: 입력값 해시 후 reservations 테이블의 값과 대조.
- 조회: 해당 전화번호 해시와 매칭되는 예약 반환(confirmed/ongoing 상태).
- 취소: 예약 선택 후 시작 전 여부 확인 → reservations.status="cancelled" 업데이트.
- 정책 위반(취소 가능 시간 경과) 시 불가.
- 동시성: row-level lock 또는 조건부 업데이트.
- 로그 기록.

**출력**  
- 조회 성공: 예약 리스트 반환.
- 취소 성공: "취소 완료" 상태로 표시.
- 실패 시 원인 코드 반환(인증 실패, 시간 경과, 이미 취소 등).
- 엣지케이스: 중복 취소 요청 → 최초 요청만 성공. 시스템 점검 시 조회는 캐시 반환, 취소 불가 안내.

---

## 결론
이 설계는 Supabase(Postgres + RPC + RLS)를 기반으로, 회의실 예약 서비스의 **조회 → 시간대 선택 → 예약 확정 → 조회/취소** 전 과정을 커버하며, 동시성, 보안, 엣지케이스를 모두 대응하도록 구성되어 있다.

